# Claude Code サブエージェントガイド

## 目次
- [サブエージェントとは](#サブエージェントとは)
- [サブエージェントの種類](#サブエージェントの種類)
- [サブエージェントの使い方](#サブエージェントの使い方)
- [実践的な活用例](#実践的な活用例)
- [ベストプラクティス](#ベストプラクティス)
- [よくある質問](#よくある質問)

---

## サブエージェントとは

**サブエージェント**は、特定のタスクを専門的に処理するための「専門家AI」です。

### 基本概念

Claude Codeは、複雑なタスクや大規模な調査が必要な場合、専門のサブエージェントに作業を委任できます。

**イメージ:**
あなたが「プロジェクトマネージャー」、Claudeが「アシスタント」、サブエージェントが「各分野の専門家」のような関係です。

```
あなた
  ↓ 指示
Claude Code（メインエージェント）
  ↓ タスクを委任
サブエージェント（専門家）
  ↓ 結果を報告
Claude Code
  ↓ 結果をまとめて報告
あなた
```

### なぜサブエージェントが必要？

以下のような状況で、サブエージェントが有用です：

1. **大規模なコードベースの探索**
   - 数百〜数千のファイルから特定の機能を探す
   - プロジェクト全体のアーキテクチャを理解する

2. **複雑な実装計画の立案**
   - 複数のファイルにまたがる機能追加の計画
   - リファクタリングの影響範囲の調査

3. **並行作業**
   - 複数の調査を同時に実行
   - 効率的な開発フロー

---

## サブエージェントの種類

Claude Codeには、主に以下のサブエージェントがあります。

### 1. Explore（探索エージェント）

**用途:** コードベースの探索と理解

**得意なこと:**
- ファイルパターンの検索（`**/*.tsx` など）
- キーワードでコード検索
- プロジェクト構造の分析
- 特定の機能の実装場所の特定

**使用例:**
```
「このプロジェクトで認証機能がどこに実装されているか調べて」
→ Exploreエージェントが複数のディレクトリを探索し、関連ファイルを特定
```

**探索レベル:**
- `quick`: 基本的な検索（最も高速）
- `medium`: 中程度の探索（バランス型）
- `very thorough`: 包括的な分析（最も詳細）

---

### 2. Plan（計画エージェント）

**用途:** 複雑なタスクの実装計画の立案

**得意なこと:**
- 複数ステップの実装計画の作成
- 影響範囲の分析
- 依存関係の特定
- タスクの優先順位付け

**使用例:**
```
「ユーザー認証機能を追加したい。実装計画を立てて」
→ Planエージェントが必要なファイル、手順、注意点を整理
```

---

### 3. General-Purpose（汎用エージェント）

**用途:** 複雑な多段階タスクの自律的な実行

**得意なこと:**
- 複雑な質問への回答
- 複数の調査を組み合わせた分析
- コード検索と実装の組み合わせ
- 繰り返しの多い作業

**使用例:**
```
「プロジェクト内の全てのAPIエンドポイントをリストアップして、
それぞれのエラーハンドリングを分析して」
→ General-Purposeエージェントが自律的に調査・分析
```

---

## サブエージェントの使い方

### 方法1: 自動的に使われる（推奨）

Claude Codeは、タスクの内容から自動的にサブエージェントを使うべきか判断します。

**例:**

```bash
claude
```

対話モードで:

```
このプロジェクトで認証機能がどこに実装されているか教えて
```

→ Claudeが自動的にExploreエージェントを起動して調査してくれます。

**メリット:**
- 使い方を覚える必要がない
- Claudeが最適なエージェントを選択
- 初心者でも簡単に使える

---

### 方法2: 明示的に指示する

より詳細な制御が必要な場合は、明示的にサブエージェントを指示できます。

**例1: 探索を依頼**

```
Exploreエージェントを使って、プロジェクト内のすべてのReactコンポーネントを見つけて
```

**例2: 計画を依頼**

```
Planエージェントを使って、ダークモード機能を追加する実装計画を立てて
```

**例3: 探索レベルを指定**

```
very thorough レベルでプロジェクト内のAPI呼び出しを全て探して
```

---

### サブエージェントの動作を確認

サブエージェントが起動すると、Claudeが教えてくれます：

```
📋 Exploreエージェントを起動して、認証機能を調査しています...
```

作業が完了すると、結果が報告されます：

```
✅ 調査完了: 認証機能は以下のファイルで実装されています:
- src/services/auth.ts
- src/hooks/useAuth.ts
- src/components/Login.tsx
```

---

## 実践的な活用例

### 例1: 大規模なコードベースの理解

**シーン:** 新しいプロジェクトに参加して、コードベースを理解したい

```bash
claude
```

対話モードで:

```
このプロジェクトのアーキテクチャを理解したい。
以下を調査して:
1. 全体的なディレクトリ構造
2. 主要な技術スタック
3. データフローの仕組み
4. 認証の実装方法
```

→ Claudeが自動的にExploreエージェントを使って、包括的に調査してくれます。

---

### 例2: 特定の機能の実装場所を探す

**シーン:** バグ修正のために、特定の機能がどこに実装されているか知りたい

```
「ユーザーのプロフィール画像をアップロードする機能が
どこに実装されているか探して」
```

→ Exploreエージェントが以下を調査:
1. 関連するコンポーネントファイル
2. APIエンドポイント
3. ストレージ処理
4. バリデーション

---

### 例3: 複雑な機能の実装計画

**シーン:** 新機能を追加したいが、どこから手をつければいいか分からない

```
「通知機能を追加したい。以下の要件を満たす実装計画を立てて:
- リアルタイム通知（WebSocket）
- 通知の一覧表示
- 既読/未読の管理
- プッシュ通知
」
```

→ Planエージェントが以下を提供:
1. 必要なファイルのリスト
2. 実装順序
3. 各ステップの詳細
4. 注意すべき点

---

### 例4: リファクタリングの影響範囲の調査

**シーン:** 関数名を変更したいが、影響範囲を知りたい

```
「getUserData関数の名前をfetchUserProfileに変更したい。
影響を受けるファイルを全て見つけて」
```

→ Exploreエージェントが以下を実行:
1. getUserData関数の使用箇所を全て検索
2. インポート文を確認
3. 影響を受けるテストファイルを特定
4. リファクタリング計画を提案

---

### 例5: パフォーマンス問題の調査

**シーン:** アプリが遅いので、ボトルネックを特定したい

```
「このプロジェクトのパフォーマンス問題を調査して。
特に以下をチェック:
- 不要なre-render
- 大きなバンドルサイズ
- 重い計算処理
- メモリリーク
」
```

→ General-Purposeエージェントが包括的に調査し、改善案を提示

---

## ベストプラクティス

### 1. タスクを明確に伝える

サブエージェントが効果的に動作するには、タスクを明確に伝えることが重要です。

**悪い例:**
```
このプロジェクトを調べて
```

**良い例:**
```
このプロジェクトで以下を調査して:
1. 認証機能の実装場所
2. 使用しているライブラリ
3. セキュリティ対策
```

---

### 2. 探索レベルを使い分ける

タスクの重要度や時間制約に応じて、探索レベルを調整します。

**Quick（高速）:**
- 簡単な検索
- 時間が限られている場合
- 概要を把握したい場合

**Medium（バランス）:**
- 通常の調査（デフォルト）
- ある程度詳細な情報が必要な場合

**Very Thorough（詳細）:**
- 包括的な分析が必要な場合
- 見落としがあると困る場合
- リファクタリング前の影響範囲調査

---

### 3. 複数のサブエージェントを並行実行

複数の独立した調査がある場合、並行実行で時間を節約できます。

**例:**

```
以下を並行して調査して:
1. 認証機能の実装
2. データベーススキーマ
3. APIエンドポイントの一覧
```

→ Claudeが複数のExploreエージェントを同時に起動

---

### 4. サブエージェントの結果を確認

サブエージェントの結果は、必ず内容を確認しましょう。

**確認ポイント:**
- 調査結果は期待通りか
- 見落としはないか
- 追加で調査が必要な箇所はないか

---

### 5. 段階的に深掘りする

最初は広く浅く調査し、必要に応じて深掘りします。

**ステップ1: 広く浅く**
```
プロジェクト全体の構造を教えて
```

**ステップ2: 特定の領域を深掘り**
```
認証機能について詳しく調査して
```

**ステップ3: さらに詳細を**
```
トークンのリフレッシュ処理の実装を詳しく見て
```

---

## よくある質問

### Q: サブエージェントを使うと追加料金がかかる？

**A:** サブエージェントも通常のClaude Codeの使用料金に含まれます。ただし、サブエージェントは複雑な処理を行うため、トークン消費量が多くなる場合があります。

**コスト最適化のTips:**
- 必要なタスクだけに使う
- 探索レベルを適切に選択（quickで十分な場合は quick を使う）
- 具体的な指示で無駄な調査を減らす

---

### Q: サブエージェントの処理にどのくらい時間がかかる？

**A:** タスクの複雑さとコードベースのサイズによります。

**目安:**
- Quick探索: 数秒〜10秒
- Medium探索: 10秒〜30秒
- Very Thorough探索: 30秒〜数分

大規模なプロジェクトでは、より時間がかかる場合があります。

---

### Q: サブエージェントが期待した結果を返さない

**A:** 以下を試してください:

1. **タスクをより具体的に指示する**
   ```
   悪い: 「認証を調べて」
   良い: 「JWTトークンの検証処理がどこに実装されているか探して」
   ```

2. **探索レベルを上げる**
   ```
   「very thorough レベルで再調査して」
   ```

3. **段階的にアプローチする**
   ```
   ステップ1: 「認証関連のファイルを全てリストアップして」
   ステップ2: 「その中でトークン検証を行っているファイルを特定して」
   ```

---

### Q: サブエージェントと通常のClaude Codeの違いは？

**A:**

| | 通常のClaude Code | サブエージェント |
|---|---|---|
| **用途** | 対話的な開発支援 | 特定タスクの専門処理 |
| **動作** | その場で回答 | バックグラウンドで処理 |
| **適した作業** | ファイル編集、質問への回答 | 大規模探索、計画立案 |
| **コンテキスト** | 会話の文脈を保持 | タスク特化 |

---

### Q: サブエージェントを手動でキャンセルできる？

**A:** 通常は自動的に完了を待ちますが、処理が長すぎる場合は `Ctrl+C` で中断できます。

---

### Q: プロジェクトが大きすぎてサブエージェントが動かない

**A:** 以下の対処法があります:

1. **調査範囲を限定する**
   ```
   「src/services/ ディレクトリ内だけで認証機能を探して」
   ```

2. **.claudeignore で不要なディレクトリを除外**
   ```
   # .claudeignore
   node_modules/
   dist/
   build/
   .git/
   ```

   詳しくは [.claudeignoreガイド](./11-claudeignore-guide.md) を参照。

3. **より具体的なキーワードで検索**
   ```
   「"JWT" "verify" というキーワードでファイルを検索して」
   ```

---

## サブエージェントを活用した開発フロー

### フロー例: 新機能の追加

**ステップ1: 現状を理解（Explore）**
```
既存の通知機能がどのように実装されているか調査して
```

**ステップ2: 計画を立てる（Plan）**
```
リアルタイム通知機能を追加する実装計画を立てて
```

**ステップ3: 実装（通常のClaude Code）**
```
計画に従って、まずWebSocketのセットアップをして
```

**ステップ4: 影響範囲の確認（Explore）**
```
今追加した機能が既存のコードに影響していないか確認して
```

**ステップ5: テスト（通常のClaude Code）**
```
追加した機能のテストを作成して実行して
```

---

## まとめ

サブエージェントは、以下のような場合に特に有用です:

✅ **大規模なコードベースの探索**
✅ **複雑な実装計画の立案**
✅ **リファクタリングの影響範囲調査**
✅ **並行して複数の調査を実行**
✅ **特定の機能の実装場所の特定**

**効果的な使い方:**
- タスクを明確に伝える
- 探索レベルを適切に選択
- 結果を確認して追加調査を依頼
- 段階的にアプローチする

---

## 次のステップ

サブエージェントを理解したら、他の高度な機能も学びましょう:

- [HOOKSガイド](./08-hooks-guide.md): イベント駆動の自動化
- [Slash Commandsガイド](./09-slash-commands-guide.md): カスタムコマンドの作成
- [MCPガイド](./10-mcp-guide.md): 外部ツールとの統合

---

**参考:**
- [Claude Code 公式ドキュメント](https://code.claude.com/docs)
